on:
  push:
    branches:
      - dev
      - main
  pull_request:
    branches:
      - dev
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"

jobs:
  ci:
    name: CI - Test, Lint & Build
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: dbname
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          pip install uv

      - name: Create virtual environment & install dependencies
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          uv sync

      - name: Lint & format check
        run: |
          source .venv/bin/activate
          uv run ruff check .
          uv run ruff format --check .

      - name: Run database migrations
        run: |
          source .venv/bin/activate
          uv run alembic upgrade head

      - name: Run tests
        run: |
          source .venv/bin/activate
          uv run pytest tests/ --verbose

      - name: Build project
        run: |
          source .venv/bin/activate
          uv build
          echo "Build completed successfully."

  cd:
    name: CD - Deploy Backend
    runs-on: ubuntu-latest
    needs: ci
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment variables
        id: vars
        env:
          PROD_SSH_KEY: ${{ secrets.PROD_PASS }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_PASS }}
        run: |
          set -ex
          if [ "$GITHUB_REF" == "refs/heads/main" ]; then
            ENV=production
            BRANCH=main
            SERVER_USER=${{ secrets.PROD_USER }}
            SERVER_IP=${{ secrets.PROD_IP }}
            SSH_KEY_CONTENT="$PROD_SSH_KEY"
            DB_NAME=${{ secrets.DB_NAME }}
            REMOTE_DIR="/home/ifeanyinw/apps/backend/legal-watch-dog-be"
            REPO_URL="https://github.com/hngprojects/legal-watch-dog-be.git"
            ALLOW_TEST_EMAILS=false
          else
            ENV=staging
            BRANCH=dev
            SERVER_USER=${{ secrets.STAGING_USER }}
            SERVER_IP=${{ secrets.STAGING_IP }}
            SSH_KEY_CONTENT="$STAGING_SSH_KEY"
            DB_NAME=${{ secrets.STAGING_DB_NAME }}
            REMOTE_DIR="/home/ubuntu/apps/backend/ec2-for-tasing"
            REPO_URL="https://github.com/Kelkaal/ec2-for-tasing-.git"
            ALLOW_TEST_EMAILS=true
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "server_user=$SERVER_USER" >> $GITHUB_OUTPUT
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "db_name=$DB_NAME" >> $GITHUB_OUTPUT
          echo "remote_dir=$REMOTE_DIR" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "allow_test_emails=$ALLOW_TEST_EMAILS" >> $GITHUB_OUTPUT
          echo "ssh_key<<EOF" >> $GITHUB_OUTPUT
          echo "$SSH_KEY_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate .env file
        run: |
          cat <<EOF > .env.${{ steps.vars.outputs.environment }}
          DEBUG=False
          APP_PORT="${{ secrets.APP_PORT || '8001' }}"
          APP_NAME="LEGAL WATCH DOG"
          APP_VERSION="1.0.0"
          ENVIRONMENT="${{ steps.vars.outputs.environment }}"
          SECRET_KEY="${{ secrets.SECRET_KEY }}"
          LEGAL_WATCH_DOG_BASE_URL="${{ secrets.BASE_URL }}"
          DB_TYPE="postgresql"
          DB_HOST="${{ secrets.DB_HOST }}"
          DB_PORT="${{ secrets.DB_PORT }}"
          DB_USER="${{ secrets.DB_USER }}"
          DB_PASS="${{ secrets.DB_PASS }}"
          DB_NAME="${{ steps.vars.outputs.db_name }}"
          DATABASE_URL="postgresql+asyncpg://${{ secrets.DB_USER }}:${{ secrets.DB_PASS }}@${{ secrets.DB_HOST }}/${{ steps.vars.outputs.db_name }}"
          MAIL_MAILER="smtp"
          SMTP_SERVER="${{ secrets.SMTP_SERVER }}"
          SMTP_PORT="${{ secrets.SMTP_PORT }}"
          MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}"
          MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}"
          MAIL_ENCRYPTION="${{ secrets.MAIL_ENCRYPTION }}"
          EMAIL="${{ secrets.EMAIL }}"
          MAIL_FROM_NAME="LEGAL WATCH DOG"
          REDIS_URL="${{ secrets.REDIS_URL }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          JWT_ALGORITHM="${{ secrets.JWT_ALGORITHM }}"
          JWT_EXPIRY="${{ secrets.JWT_EXPIRY }}"
          ACCESS_TOKEN_EXPIRATION="${{ secrets.ACCESS_TOKEN_EXPIRATION }}"
          ALLOW_TEST_EMAIL_PROVIDERS="${{ steps.vars.outputs.allow_test_emails }}"
          TEST_EMAIL_PROVIDERS="gmail.com"
          ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}"
          EOF

      - name: Setup SSH key
        run: |
          echo "${{ steps.vars.outputs.ssh_key }}" > private_key.pem
          chmod 400 private_key.pem

      - name: Deploy to server
        run: |
          scp -o StrictHostKeyChecking=no -i private_key.pem .env.${{ steps.vars.outputs.environment }} \
            ${{ steps.vars.outputs.server_user }}@${{ steps.vars.outputs.server_ip }}:/tmp/backend_env

          ssh -o StrictHostKeyChecking=no -i private_key.pem \
            ${{ steps.vars.outputs.server_user }}@${{ steps.vars.outputs.server_ip }} << EOF
            set -e

            if [ ! -d "${{ steps.vars.outputs.remote_dir }}" ]; then
              mkdir -p "$(dirname "${{ steps.vars.outputs.remote_dir }}")"
              git clone "${{ steps.vars.outputs.repo_url }}" "${{ steps.vars.outputs.remote_dir }}"
            fi

            cd "${{ steps.vars.outputs.remote_dir }}"
            git pull origin "${{ steps.vars.outputs.branch }}"
            mv /tmp/backend_env .env

            if ! command -v uv &> /dev/null; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
            fi

            uv sync
            uv run alembic upgrade head

            set -a
            source .env
            set +a

            PM2_APP_NAME="legal-watchdog-be-${{ steps.vars.outputs.environment }}"
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi

            pm2 describe "$PM2_APP_NAME" > /dev/null 2>&1 && pm2 delete "$PM2_APP_NAME" || echo "No existing process found"
            pm2 start ecosystem.config.js --update-env
            pm2 save
            pm2 startup systemd -u "$(whoami)" --hp "$(echo "$HOME")" || true
            pm2 status
          EOF
  notify_slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: cd
    if: always()
    steps:
      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          DEPLOY_RESULT: ${{ needs.cd.result }}
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # Determine environment name
          if [ "$BRANCH_NAME" == "main" ]; then
            ENV_NAME="Production"
          else
            ENV_NAME="Staging"
          fi

          # Determine status
          if [ "$DEPLOY_RESULT" == "success" ]; then
            STATUS_COLOR="good"
            MAIN_STATUS="✅ Deployment Successful"
          else
            STATUS_COLOR="danger"
            MAIN_STATUS="❌ Deployment Failed"
          fi

          LOG_LINK="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          PAYLOAD="{
            \"attachments\": [
              {
                \"color\": \"${STATUS_COLOR}\",
                \"blocks\": [
                  {\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"⚙️ Backend Deployment Update\", \"emoji\": true}},
                  {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"*${MAIN_STATUS}* Environment: ${ENV_NAME}\\nBranch: ${BRANCH_NAME}\\nTriggered by: ${GITHUB_ACTOR}\"}},
                  {\"type\": \"divider\"},
                  {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"Check <${LOG_LINK}|logs> or contact dev team.\"}}
                ]
              }
            ]
          }"
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" $SLACK_WEBHOOK
