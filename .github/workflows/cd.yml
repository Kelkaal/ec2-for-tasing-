name: Backend CD - Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy_main:
    name: CD - Backend Deploy (Main)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate main environment file
        run: |
          cat <<EOF > .env.main
          DEBUG=False
          APP_PORT="${{ secrets.APP_PORT || vars.APP_PORT || '8001' }}"
          APP_NAME="${{ vars.APP_NAME || 'LEGAL WATCH DOG' }}"
          APP_VERSION="${{ vars.APP_VERSION || '1.0.0' }}"
          ENVIRONMENT="main"
          SECRET_KEY="${{ secrets.SECRET_KEY }}"
          LEGAL_WATCH_DOG_BASE_URL="${{ secrets.BASE_URL || vars.BASE_URL }}"

          DB_TYPE="${{ vars.DB_TYPE || 'postgresql' }}"
          DB_HOST="${{ secrets.DB_HOST }}"
          DB_PORT="${{ secrets.DB_PORT }}"
          DB_USER="${{ secrets.DB_USER }}"
          DB_PASS="${{ secrets.DB_PASS }}"
          DB_NAME="${{ secrets.DB_NAME }}"
          DATABASE_URL="postgresql+asyncpg://${{ secrets.DB_USER }}:${{ secrets.DB_PASS }}@${{ secrets.DB_HOST }}/${{ secrets.DB_NAME }}"

          MAIL_MAILER="${{ vars.MAIL_MAILER || 'smtp' }}"
          SMTP_SERVER="${{ secrets.SMTP_SERVER }}"
          SMTP_PORT="${{ secrets.SMTP_PORT }}"
          MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}"
          MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}"
          MAIL_ENCRYPTION="${{ secrets.MAIL_ENCRYPTION }}"
          EMAIL="${{ secrets.EMAIL }}"
          MAIL_FROM_NAME="${{ vars.MAIL_FROM_NAME || 'LEGAL WATCH DOG' }}"

          APP_URL="${{ vars.APP_URL || '3.80.70.234' }}"
          DEV_URL="${{ vars.DEV_URL || 'http://localhost:3000' }}"
          REDIS_URL="${{ secrets.REDIS_URL }}"
          REDIS_CACHE_TTL_SECONDS="${{ secrets.REDIS_CACHE_TTL_SECONDS }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          JWT_ALGORITHM="${{ secrets.JWT_ALGORITHM }}"
          JWT_EXPIRY="${{ secrets.JWT_EXPIRY }}"
          ACCESS_TOKEN_EXPIRATION="${{ secrets.ACCESS_TOKEN_EXPIRATION }}"

          ALLOW_TEST_EMAIL_PROVIDERS="${{ vars.ALLOW_TEST_EMAIL_PROVIDERS || 'false' }}"
          TEST_EMAIL_PROVIDERS="${{ vars.TEST_EMAIL_PROVIDERS || 'gmail.com' }}"
          ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}"
          EOF

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Upload .env file to server
        run: |
          sshpass -p "${{ secrets.PROD_PASS }}" scp -o StrictHostKeyChecking=no .env.main ${{ secrets.PROD_USER }}@${{ secrets.PROD_IP }}:/tmp/backend_env

      - name: Set up SSH and Deploy
        env:
          SERVER_PASS: ${{ secrets.PROD_PASS }}
          SERVER_USER: ${{ secrets.PROD_USER }}
          SERVER_IP: ${{ secrets.PROD_IP }}
        run: |
          sshpass -p "$SERVER_PASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP << 'EOF'
            set -e

            REMOTE_DIR="/home/ubuntu/apps/backend/ec2-for-tasing-"
            
            # Clone if the directory doesn't exist
            if [ ! -d "$REMOTE_DIR" ]; then
              cd /home/ubuntu/apps/backend/
              git clone https://github.com/Kelkaal/ec2-for-tasing-.git "$REMOTE_DIR"
            fi

            cd "$REMOTE_DIR"
            
            git pull origin main
            
            mv /tmp/backend_env .env

            # Install uv if not present
            if ! command -v uv &> /dev/null; then
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
            fi
            
            uv sync
            uv run alembic upgrade head
            
            set -a 
            source .env 
            set +a
            
            PM2_APP_NAME="legal-watchdog-be-main"
            
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi
            
            if pm2 describe "$PM2_APP_NAME" > /dev/null 2>&1; then
              PM2_STATUS=$(pm2 jlist | jq -r ".[] | select(.name==\"$PM2_APP_NAME\") | .pm2_env.status" 2>/dev/null || echo "stopped")
              if [ "$PM2_STATUS" == "errored" ] || [ "$PM2_STATUS" == "stopped" ]; then
                pm2 delete "$PM2_APP_NAME" || true
              fi
            fi
            
            cat > start_app.sh << 'SCRIPTEND'
            #!/bin/bash
            cd /home/ubuntu/apps/backend/ec2-for-tasing-
            source .env
            uv run uvicorn main:app --host 0.0.0.0 --port $APP_PORT
            SCRIPTEND
            
            chmod +x start_app.sh
            
            if pm2 describe "$PM2_APP_NAME" > /dev/null 2>&1; then
              pm2 restart "$PM2_APP_NAME" --update-env
            else
              pm2 start ./start_app.sh --name "$PM2_APP_NAME"
            fi
            
            pm2 save
            pm2 startup systemd -u $(whoami) --hp $(echo $HOME) || true
          EOF
          
